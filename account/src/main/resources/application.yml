# --- App base ---
spring:
  application:
    name: account
  main:
    web-application-type: reactive
  r2dbc:
    url: r2dbc:postgresql://localhost:5433/accountdb
    username: postgres
    password: postgres
  flyway:
    enabled: true
    url: jdbc:postgresql://localhost:5433/accountdb
    user: postgres
    password: postgres
    locations: classpath:db/migration
    schemas: public
    baseline-on-migrate: true
    driver-class-name: org.postgresql.Driver
  cache:
    cache-names: clients
    caffeine:
      spec: maximumSize=10000,expireAfterWrite=10m

server:
  port: 8080
  address: 0.0.0.0

# Logs útiles
logging:
  level:
    root: INFO
    org.flywaydb: INFO
    org.springframework.r2dbc: INFO

# --- Servicio externo ---
client:
  service:
    base-url: http://localhost:8081/api/clients

resilience4j:
  circuitbreaker:
    instances:
      clientService:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 20              # ventana de evaluación (20 llamadas)
        minimumNumberOfCalls: 10           # no evalúa umbrales antes de 10 llamadas
        failureRateThreshold: 50           # abre si >= 50% fallan
        slowCallDurationThreshold: 2s      # llamadas lentas > 2s
        slowCallRateThreshold: 50          # considera lento si >= 50% son lentas
        permittedNumberOfCallsInHalfOpenState: 5
        waitDurationInOpenState: 30s       # tiempo abierto antes de pasar a half-open
        automaticTransitionFromOpenToHalfOpenEnabled: true
        recordExceptions:
          - org.springframework.web.reactive.function.client.WebClientRequestException
          - org.springframework.web.reactive.function.client.WebClientResponseException
  retry:
    instances:
      clientService:
        maxAttempts: 3                     # 1 intento inicial + 2 reintentos
        waitDuration: 200ms                # backoff base
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2.0  # 200ms, 400ms
        retryExceptions:
          - org.springframework.web.reactive.function.client.WebClientRequestException   # timeouts/conexión
        ignoreExceptions:
          - org.springframework.web.reactive.function.client.WebClientResponseException$BadRequest  # 400 no reintentar
  bulkhead:
    instances:
      clientService:
        maxConcurrentCalls: 10
        maxWaitDuration: 0                  # no esperar si está saturado
